<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="http://example.com/2023/10/16/SpringCloud/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/microServiceStruct.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/loadBalance.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/IRule.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/nacosDetail.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/cfgGetSequence.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/feignExtract.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/gatewaySequence.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/gatewayFilter.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/rabbitmqStruct.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/HelloWorldDemo.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/workqueueStruct.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/publishSubscribeStruct.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/fanoutExchangeStruct.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/directExchangeStruct.png">
<meta property="og:image" content="http://example.com/2023/10/16/SpringCloud/topicExchangeStruct.png">
<meta property="article:published_time" content="2023-10-16T12:22:28.000Z">
<meta property="article:modified_time" content="2023-10-24T11:02:45.443Z">
<meta property="article:author" content="MANVND">
<meta property="article:tag" content="JavaWeb">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/10/16/SpringCloud/microServiceStruct.png">

<link rel="canonical" href="http://example.com/2023/10/16/SpringCloud/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>SpringCloud | Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/16/SpringCloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="MANVND">
      <meta itemprop="description" content="There is no royal road to learning">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringCloud
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-10-16 20:22:28" itemprop="dateCreated datePublished" datetime="2023-10-16T20:22:28+08:00">2023-10-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-24 19:02:45" itemprop="dateModified" datetime="2023-10-24T19:02:45+08:00">2023-10-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <html><head></head><body><h1 id="微服务结构"><a href="#微服务结构" class="headerlink" title="微服务结构"></a>微服务结构</h1><p><img src="/2023/10/16/SpringCloud/microServiceStruct.png" alt="microServiceStruct"></p>
<h1 id="认识微服务"><a href="#认识微服务" class="headerlink" title="认识微服务"></a>认识微服务</h1><h2 id="服务架构演变"><a href="#服务架构演变" class="headerlink" title="服务架构演变"></a>服务架构演变</h2><h3 id="单体架构"><a href="#单体架构" class="headerlink" title="单体架构"></a>单体架构</h3><p><strong>单体架构</strong>：将业务的所有功能集中在一个项目中开发，打成一个包部署</p>
<p><strong>优点</strong>：</p>
<ul>
<li>架构简单</li>
<li>部署成本低</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>耦合度高</li>
</ul>
<h3 id="分布式架构"><a href="#分布式架构" class="headerlink" title="分布式架构"></a>分布式架构</h3><p><strong>分布式架构</strong>：根据业务功能对系统进行拆分，每个业务模块作为独立项目开发，称为一个服务</p>
<p><strong>优点</strong>：</p>
<ul>
<li>降低服务耦合</li>
<li>有利于服务升级拓展</li>
</ul>
<p><strong>考虑的问题</strong>：</p>
<ul>
<li>服务拆分粒度如何？</li>
<li>服务集群的地址如何维护？</li>
<li>服务之间如何实现远程调用？</li>
<li>服务健康状态如何感知？</li>
</ul>
<h3 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h3><p>微服务是一种经过良好架构设计的<strong>分布式</strong>架构方案，微服务架构特征：</p>
<ul>
<li><p>单一职责：微服务拆分粒度更小，每一个服务都对应唯一的业务能力，做到单一职责，避免重复业务开发</p>
</li>
<li><p>面向服务：微服务对外暴露业务接口</p>
</li>
<li><p>自治：团队独立，技术独立，数据独立，部署独立</p>
</li>
<li><p>隔离性强：服务调用做好隔离、容错、降级、避免出现级联问题</p>
</li>
</ul>
<h3 id="微服务结构-1"><a href="#微服务结构-1" class="headerlink" title="微服务结构"></a>微服务结构</h3><p>微服务这种方案需要技术框架来落地，全球的互联网公司都在家积极尝试自己的微服务落地技术。在国内最知名的就是SpringCloud和阿里巴巴的Dubbo</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">Dubbo</th>
<th align="center">SpringCloud</th>
<th align="center">SpringCloudAlibaba</th>
</tr>
</thead>
<tbody><tr>
<td align="center">注册中心</td>
<td align="center">zookeeper、Redis</td>
<td align="center">Eureka、Consul</td>
<td align="center">Nacos、Eureka</td>
</tr>
<tr>
<td align="center">服务远程调用</td>
<td align="center">Dubbo协议</td>
<td align="center">Feign（http协议）</td>
<td align="center">Dubbo、Feign</td>
</tr>
<tr>
<td align="center">配置中心</td>
<td align="center">无</td>
<td align="center">SpringCloudConfig</td>
<td align="center">SpringCloudConfig、Nacos</td>
</tr>
<tr>
<td align="center">服务网关</td>
<td align="center">无</td>
<td align="center">SpringCloudGateway、Zuul</td>
<td align="center">SpringCloudGateway、Zuul</td>
</tr>
<tr>
<td align="center">服务监控和保护</td>
<td align="center">Dubbo-admin，功能弱</td>
<td align="center">Hystrix</td>
<td align="center">Sentinel</td>
</tr>
</tbody></table>
<h2 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h2><ul>
<li>目前国内使用最广泛的微服务框架</li>
<li>SpringCloud集成了各种微服务功能组件，并基于SpringBoot实现了这些组件的自动装配，从而提供了良好的开箱即用体验</li>
</ul>
<h1 id="服务拆分和远程调用"><a href="#服务拆分和远程调用" class="headerlink" title="服务拆分和远程调用"></a>服务拆分和远程调用</h1><h2 id="服务拆分注意事项"><a href="#服务拆分注意事项" class="headerlink" title="服务拆分注意事项"></a>服务拆分注意事项</h2><ol>
<li>不同的微服务，不要重复开发相同业务</li>
<li>微服务数据独立，不要访问其他微服务的数据库</li>
<li>微服务可以将自己的业务暴露为接口，供其他微服务调用</li>
</ol>
<h2 id="微服务远程调用"><a href="#微服务远程调用" class="headerlink" title="微服务远程调用"></a>微服务远程调用</h2><h3 id="使用RestTemplate"><a href="#使用RestTemplate" class="headerlink" title="使用RestTemplate"></a>使用RestTemplate</h3><ol>
<li>注册RestTemplate</li>
<li>服务远程调用RestTemplate</li>
</ol>
<h3 id="提供者与消费者"><a href="#提供者与消费者" class="headerlink" title="提供者与消费者"></a>提供者与消费者</h3><ul>
<li>服务提供者：一次业务中，被其他微服务调用的服务。（提供接口给其它微服务）</li>
<li>服务消费者：一次业务中，调用其它微服务的服务。（调用其它微服务提供的接口）</li>
</ul>
<p>一个服务既可以是提供者也可以是消费者</p>
<h1 id="Eureka注册中心"><a href="#Eureka注册中心" class="headerlink" title="Eureka注册中心"></a>Eureka注册中心</h1><h2 id="Eureka的作用"><a href="#Eureka的作用" class="headerlink" title="Eureka的作用"></a>Eureka的作用</h2><ul>
<li>消费者该如何获取服务提供者具体信息<ul>
<li>服务提供者启动时向eureka注册自己的信息</li>
<li>eureka保存这些信息</li>
<li>消费者根据服务名称向eureka拉取提供者信息</li>
</ul>
</li>
<li>如果有多个服务提供者，消费者如何选择<ul>
<li>服务消费者利用负载均衡算法，从服务列表中挑选一个</li>
</ul>
</li>
<li>消费者如何感知服务提供者健康状态<ul>
<li>服务提供者会每隔30秒向EurekaServer发送心跳请求，报告健康状态</li>
<li>eureka会更新记录服务列表信息，心跳不正常会被剔除</li>
<li>消费者就可以拉取到最新的信息</li>
</ul>
</li>
</ul>
<h2 id="搭建EurekaServer"><a href="#搭建EurekaServer" class="headerlink" title="搭建EurekaServer"></a>搭建EurekaServer</h2><p>步骤如下：</p>
<ol>
<li><p>创建项目，引入spring-cloud-starter-netflix-eureka-server的依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groudId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groudId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflex-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>编写启动类，添加@EnableEurekaServer注解</p>
</li>
<li><p>添加application.yml文件，编写下面配置</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">	<span class="attr">port:</span> <span class="number">10086</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">application:</span></span><br><span class="line">		<span class="attr">name:</span> <span class="string">eurakaserver</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">	<span class="attr">client:</span></span><br><span class="line">		<span class="attr">service-url:</span></span><br><span class="line">			<span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka/</span></span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h2 id="注册user-service"><a href="#注册user-service" class="headerlink" title="注册user-service"></a>注册user-service</h2><p>将user-service服务注册到EurekaServer步骤如下</p>
<ol>
<li><p>在pom项目引入spring-cloud-start-netflix-eureka-client的依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在applicaiton.yml文件，编写如下配置</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">application:</span></span><br><span class="line">		<span class="attr">name:</span> <span class="string">userService</span></span><br><span class="line">		</span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">	<span class="attr">client:</span></span><br><span class="line">		<span class="attr">service-url:</span></span><br><span class="line">			<span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka/</span></span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<p>另外，可已经一个实例多次启动，模拟多实例部署，但为了避免端口冲突，需要修改端口设置：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VM options</span></span><br><span class="line">-Dserver.port=8082</span><br></pre></td></tr></tbody></table></figure>

<h2 id="服务拉取"><a href="#服务拉取" class="headerlink" title="服务拉取"></a>服务拉取</h2><p>服务拉取是基于服务名称获取服务列表，然后在服务列表做负载均衡</p>
<ol>
<li><p>使用服务名代替ip，端口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">"http://userservice/user/"</span> + order.getUserId()</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在项目的启动类中的RestTemplate添加<strong>负载均衡</strong>注解</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h2 id="Ribbon负载均衡"><a href="#Ribbon负载均衡" class="headerlink" title="Ribbon负载均衡"></a>Ribbon负载均衡</h2><h3 id="负载均衡流程"><a href="#负载均衡流程" class="headerlink" title="负载均衡流程"></a>负载均衡流程</h3><p><img src="/2023/10/16/SpringCloud/loadBalance.png" alt="loadBalance"></p>
<h3 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h3><p>Ribbon的负载均衡规则是一个叫做IRule的接口来定义的，每一个子接口都是一种规则</p>
<p><img src="/2023/10/16/SpringCloud/IRule.png" alt="IRule"></p>
<table>
<thead>
<tr>
<th align="center">内置负载均衡规则类</th>
<th align="center">规则描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">RoundRobinRule</td>
<td align="center">简单轮询服务列表来选择服务器。它是Ribbon默认的负载均衡规则</td>
</tr>
<tr>
<td align="center">AvailabilityFilteringRule</td>
<td align="center">对一下两种服务器进行忽略：1.在默认情况下，这台服务器如果3次连接失败，这台服务器就会被设置为“短路”状态。短路状态将持续30秒，如果再次连接失败，短路的持续时间就会几何级地增加2.并发数过高的服务器。如果一个服务器的并发连接数过高，配置了AvailabilityFilteringRule规则的客户端也将会被其忽略。并发连接数的上限，可以由客户端的&lt;clientName&gt;&lt;clientConfigNameSpace&gt;.ActiveConnectionsLimit属性进行配置</td>
</tr>
<tr>
<td align="center">WeightedResponseTimeRule</td>
<td align="center">为每一个服务器赋予一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择</td>
</tr>
<tr>
<td align="center"><strong>ZoneAvoidanceRule</strong></td>
<td align="center">以区域可用的服务器为基础进行服务器的选择。使用Zone对服务器进行分类，这个Zone可以理解为一个机房、一个机架等。而后再对Zone内的多个服务做轮询</td>
</tr>
<tr>
<td align="center">BestAvailableRule</td>
<td align="center">忽略那些短路的服务器，并选择并发数较低的服务器</td>
</tr>
<tr>
<td align="center">RandomRule</td>
<td align="center">随机选择一个可用的服务器</td>
</tr>
<tr>
<td align="center">RetryRule</td>
<td align="center">重试机制的选择逻辑</td>
</tr>
</tbody></table>
<p>通过定义IRule实现可以修改负载均衡规则，有两种方式</p>
<ol>
<li><p>代码方式：在配置类中，定义一个新的IRule：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> IRule <span class="title function_">randomRule</span><span class="params">()</span>{</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>配置文件方式：在项目配置yml文件中，添加新的配置也可以修改规则</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">userService:</span></span><br><span class="line">	<span class="attr">ribbon:</span></span><br><span class="line">		<span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment"># 负载均衡策略</span></span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h4 id="饥饿加载"><a href="#饥饿加载" class="headerlink" title="饥饿加载"></a>饥饿加载</h4><p>Ribbon默认是采用懒加载，即第一次访问时才创建LoadBalanceClient，请求时间会很长，而饥饿加载则会在项目启动时创建，降低第一次访问的耗时，通过下面的配置开启饥饿加载：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">	<span class="attr">eager-load:</span></span><br><span class="line">		<span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启饥饿加载</span></span><br><span class="line">		<span class="attr">clients:</span> <span class="string">userService</span> <span class="comment"># 指定对userService服务进行饥饿加载</span></span><br></pre></td></tr></tbody></table></figure>

<h1 id="Nacos注册中心"><a href="#Nacos注册中心" class="headerlink" title="Nacos注册中心"></a>Nacos注册中心</h1><h2 id="认识Nacos"><a href="#认识Nacos" class="headerlink" title="认识Nacos"></a>认识Nacos</h2><p>Nacos是阿里巴巴的产业，现在是SpringCloud中的一个组件。相比Eureka功能更加丰富，在国内受欢迎程度较高</p>
<h2 id="服务注册到Nacos"><a href="#服务注册到Nacos" class="headerlink" title="服务注册到Nacos"></a>服务注册到Nacos</h2><ol>
<li><p>在父工程中添加spring-cloud-alibaba的管理依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>注释掉原本的eureka依赖</p>
</li>
<li><p>添加nacos的客户端依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>修改项目配置文件yaml，注释eureka地址，添加nacos地址</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">nacos:</span></span><br><span class="line">			<span class="attr">discovery:</span></span><br><span class="line">				<span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># nacos 服务端地址</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在项目启动类上添加注解</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h2 id="Nacos服务分级存储模型"><a href="#Nacos服务分级存储模型" class="headerlink" title="Nacos服务分级存储模型"></a>Nacos服务分级存储模型</h2><h3 id="具体模型"><a href="#具体模型" class="headerlink" title="具体模型"></a>具体模型</h3><ol>
<li>一级是服务</li>
<li>二级是集群</li>
<li>三级是实例</li>
</ol>
<h3 id="服务跨集群调用问题"><a href="#服务跨集群调用问题" class="headerlink" title="服务跨集群调用问题"></a>服务跨集群调用问题</h3><p>服务调用时尽量选择本地集群的服务，跨集群调用延迟较高，本地集群不可访问时，再去访问其他集群</p>
<h3 id="服务集群属性"><a href="#服务集群属性" class="headerlink" title="服务集群属性"></a>服务集群属性</h3><p>修改applicaiton.yml文件，添加如下内容</p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">nacos:</span></span><br><span class="line">			<span class="attr">discovery:</span></span><br><span class="line">				<span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># nacos服务端地址</span></span><br><span class="line">				<span class="attr">cluster-name:</span> <span class="string">HZ</span> <span class="comment"># 配置集群名称，也就是机房位置</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="NacosRule负载均衡策略"><a href="#NacosRule负载均衡策略" class="headerlink" title="NacosRule负载均衡策略"></a>NacosRule负载均衡策略</h2><ol>
<li>优先选择同集群服务实例列表</li>
<li>本地集群找不到提供者，才去其他集群寻找，并且会报警告</li>
<li>确定了可用实例列表后，再采用随机负载均衡挑选实例</li>
</ol>
<h2 id="根据权重负载均衡"><a href="#根据权重负载均衡" class="headerlink" title="根据权重负载均衡"></a>根据权重负载均衡</h2><p>实际部署中会出现这样的场景</p>
<ul>
<li>服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，希望性能好的机器承担更多的用户请求</li>
</ul>
<p>Nacos提供了权重配置来控制访问频率，权重越大则访问频率越高</p>
<p>可以直接在Nacos控制台修改实例的权重（0~1）</p>
<p>权重为0代表不会被访问</p>
<h2 id="环境隔离-namespace"><a href="#环境隔离-namespace" class="headerlink" title="环境隔离 - namespace"></a>环境隔离 - namespace</h2><p>Nacos中服务存储和数据存储的最外层都是一个名为namespace中的东西，用来做最外层隔离</p>
<p>可以在Nacos控制台创建namespace</p>
<ul>
<li><p>修改服务的命名空间</p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cloud:</span></span><br><span class="line">	<span class="attr">nacos:</span></span><br><span class="line">		<span class="attr">discovery:</span></span><br><span class="line">			<span class="attr">namespace:</span> <span class="string">...</span> <span class="comment"># 命名空间，填ID</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ol>
<li>namespace用来做环境隔离</li>
<li>每个namespace都有唯一id</li>
<li>不同namespace下的服务不可见</li>
</ol>
<h2 id="Nacos注册中心原理"><a href="#Nacos注册中心原理" class="headerlink" title="Nacos注册中心原理"></a>Nacos注册中心原理</h2><h3 id="Nacos注册中心细节分析"><a href="#Nacos注册中心细节分析" class="headerlink" title="Nacos注册中心细节分析"></a>Nacos注册中心细节分析</h3><img src="/2023/10/16/SpringCloud/nacosDetail.png" alt="nacosDetail" style="zoom:50%;">





<h3 id="临时实例和非临时实例"><a href="#临时实例和非临时实例" class="headerlink" title="临时实例和非临时实例"></a>临时实例和非临时实例</h3><p>服务注册到Nacos时，可以选择注册临时实例或非临时实例，通过下述配置设置</p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">nacos:</span></span><br><span class="line">			<span class="attr">discovery:</span></span><br><span class="line">				<span class="attr">ephemeral:</span> <span class="literal">false</span> <span class="comment"># 设置为非临时实例</span></span><br></pre></td></tr></tbody></table></figure>

<p>Nacos检测到临时实例down会立刻踢出临时实例，非临时实例则会保留</p>
<h2 id="Nacos和Eureka的比较"><a href="#Nacos和Eureka的比较" class="headerlink" title="Nacos和Eureka的比较"></a>Nacos和Eureka的比较</h2><h3 id="共同点"><a href="#共同点" class="headerlink" title="共同点"></a>共同点</h3><ol>
<li>都支持服务注册和服务拉取</li>
<li>都支持服务提供者心跳方式做健康监测</li>
</ol>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ol>
<li>Nacos支持服务端主动检测提供者状态；临时实例采用心跳模式，非临时实例采用主动检测模式</li>
<li>临时实例心跳不正常会被剔除，非临时实例则不会被剔除</li>
<li>Nacos支持服务列表变更的消息推送模式，服务列表更新更及时</li>
<li>Nacos集群默认采用AP方式，当集群中存在非临时实例时，采用CP模式；Eureka采用AP方式</li>
</ol>
<h1 id="Nacos配置管理"><a href="#Nacos配置管理" class="headerlink" title="Nacos配置管理"></a>Nacos配置管理</h1><h2 id="统一配置管理"><a href="#统一配置管理" class="headerlink" title="统一配置管理"></a>统一配置管理</h2><p>Nacos配置获取流程</p>
<p><img src="/2023/10/16/SpringCloud/cfgGetSequence.png" alt="cfgGetSequence"></p>
<ol>
<li><p>在Nacos控制台配置列表中添加配置，注意Data id要唯一</p>
</li>
<li><p>引入Nacos的配置管理客户端依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在项目的resource目录下添加一个bootstrap.yml文件，这个文件是引导文件，优先级高于application.yml</p>
</li>
</ol>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">userService</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 开发环境</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># Nacos地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 文件后缀名</span></span><br></pre></td></tr></tbody></table></figure>

<p>DataID格式：${spring.application.name}$-${spring.profiles.active}$.${spring.cloud.config.file-extension}$</p>
<p>##配置自动刷新</p>
<p>Nacos中的配置文件变更后，微服务无需重启就可以感知，不过需要通过下面两种配置实现</p>
<ul>
<li><p>方式一：在配置文件影响的类上添加注解@RefreshScope</p>
</li>
<li><p>方式二：使用@ConfigurationProperties注解</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "pattern")</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PatternProperties</span> {</span><br><span class="line">  <span class="keyword">private</span> String dateformat;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h2 id="多环境配置共享"><a href="#多环境配置共享" class="headerlink" title="多环境配置共享"></a>多环境配置共享</h2><p>微服务启动时会从nacos读取多个配置文件</p>
<ul>
<li>[spring.application.name]-[spring.profiles.active].yaml</li>
<li>[spring.applicaiton.name].yaml</li>
</ul>
<p>无论profile如何变化，[spring.application.name].yaml这个文件一定会加载，因此多环境共享配置可以写入这个文件</p>
<h3 id="多服务配置优先级"><a href="#多服务配置优先级" class="headerlink" title="多服务配置优先级"></a>多服务配置优先级</h3><ul>
<li>[服务名]-[环境].yaml &gt; [服务名].yaml &gt; 本地配置</li>
</ul>
<h1 id="HTTP客户端Feign"><a href="#HTTP客户端Feign" class="headerlink" title="HTTP客户端Feign"></a>HTTP客户端Feign</h1><h2 id="RestTemplate方式调用存在的问题"><a href="#RestTemplate方式调用存在的问题" class="headerlink" title="RestTemplate方式调用存在的问题"></a>RestTemplate方式调用存在的问题</h2><p>对比原本利用RestTemplate发启动远程调用代码</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">"http://userService/user/"</span> + order.getUserId();</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> restTemplate.getForObject(url, User.class);</span><br></pre></td></tr></tbody></table></figure>

<p>存在以下问题：</p>
<ul>
<li>代码可读性差，编程体验不统一</li>
<li>参数复杂，URL难以维护</li>
</ul>
<h2 id="Feign的介绍"><a href="#Feign的介绍" class="headerlink" title="Feign的介绍"></a>Feign的介绍</h2><p>Feign是一个声明式的http客户端，其作用就是优雅的实现http请求的发送</p>
<h2 id="定义和使用Feign客户端"><a href="#定义和使用Feign客户端" class="headerlink" title="定义和使用Feign客户端"></a>定义和使用Feign客户端</h2><ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在启动类添加注解开启Feign的功能</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>编写Feign客户端</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient("userService")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> {</span><br><span class="line">  <span class="meta">@GetMapping("user/{id}")</span></span><br><span class="line">  User <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable("id")</span> Long id)</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>主要是基于SpringMVC的注解来声明远程调用的信息，如：</p>
<ul>
<li>服务名称：userService</li>
<li>请求方式：GET</li>
<li>请求路径：/user/{id}</li>
<li>请求参数：Long id</li>
<li>返回值类型：User</li>
</ul>
</li>
</ol>
<h2 id="自定义Feign的配置"><a href="#自定义Feign的配置" class="headerlink" title="自定义Feign的配置"></a>自定义Feign的配置</h2><p>Feign运行自定义配置来覆盖默认配置，可以修改的配置如下：</p>
<table>
<thead>
<tr>
<th align="center">类型</th>
<th align="center">作用</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">feign.Logger.Level</td>
<td align="center">修改日志级别</td>
<td align="center">包含四种不同的级别：NONE、BASIC、HEADERS、FULL</td>
</tr>
<tr>
<td align="center">Feign.codec.Decoder</td>
<td align="center">响应结果的解析器</td>
<td align="center">http远程调用的结果做解析，例如解析json字符串为java对象</td>
</tr>
<tr>
<td align="center">Feign.codec.Encoder</td>
<td align="center">请求参数编码</td>
<td align="center">将请求参数编码，便于通过http请求发送</td>
</tr>
<tr>
<td align="center">feign.Contract</td>
<td align="center">支持的注解格式</td>
<td align="center">默认是SpringMVC的注解</td>
</tr>
<tr>
<td align="center">feign.Retryer</td>
<td align="center">失败重试机制</td>
<td align="center">请求失败的重试机制，默认是没有，不过会使用Ribbon的重试</td>
</tr>
</tbody></table>
<p>一般需要配置的是日志级别</p>
<p>配置Feign日志有两种方式：</p>
<ul>
<li><p>方式一：配置文件方式</p>
<ol>
<li><p>全局生效</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">openfeign:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">          <span class="attr">default:</span> <span class="comment"># default是全局配置，如果写服务名称，则是针对某个微服务的配置</span></span><br><span class="line">            <span class="attr">logger-level:</span> <span class="string">FULL</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>局部生效</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">openfeign:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">          <span class="attr">userService:</span> <span class="comment"># default是全局配置，如果写服务名称，则是针对某个微服务的配置</span></span><br><span class="line">            <span class="attr">logger-level:</span> <span class="string">FULL</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
</li>
<li><p>方式二：java代码方式，需要先声明一个Bean：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignClientConfiguration</span> {</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> Logger.Level <span class="title function_">feignLogLevel</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> Logger.Level.BASIC;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如果是全局配置，则把它放到@EnableFeignClients注解中</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(defaultConfiguration = FeignClientConfiguration.class)</span></span><br></pre></td></tr></tbody></table></figure>

<p>如果是局部配置，则把它放到@FeignClient注解中</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = "userService", configuraion = FeignClientConfiguration.class)</span></span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h2 id="Feign的性能优化"><a href="#Feign的性能优化" class="headerlink" title="Feign的性能优化"></a>Feign的性能优化</h2><p>Feign底层的客户端实现</p>
<ul>
<li>URLConnection：默认实现，不支持连接池</li>
<li>Apache HttpClient：支持连接池</li>
<li>OKHttp：支持连接池</li>
</ul>
<p>因此，优化Feign的性能主要包括：</p>
<ol>
<li>使用连接池代替默认的URLConnection</li>
<li>日志级别，最好用basic或none</li>
</ol>
<h3 id="Feign的性能优化-连接池配置"><a href="#Feign的性能优化-连接池配置" class="headerlink" title="Feign的性能优化-连接池配置"></a>Feign的性能优化-连接池配置</h3><p>Feign添加HttpClient的支持：</p>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>配置连接池</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">openfeign:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">          <span class="attr">default:</span></span><br><span class="line">            <span class="attr">logger-level:</span> <span class="string">BASIC</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启feign对HttpClient的支持</span></span><br><span class="line">        <span class="attr">max-connections:</span> <span class="number">200</span> <span class="comment"># 最大的连接数</span></span><br><span class="line">        <span class="attr">max-connections-per-route:</span> <span class="number">50</span> <span class="comment"># 每个路径的最大连接数</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="Feign的最佳实践"><a href="#Feign的最佳实践" class="headerlink" title="Feign的最佳实践"></a>Feign的最佳实践</h2><ul>
<li>方法一（继承）：给消费者的FeignClient和提供者的controller定义统一的父接口作为标准<ul>
<li>服务紧耦合</li>
<li>父接口参数列表中的映射不会被继承</li>
</ul>
</li>
<li>方式二（抽取）：将FeignClient抽取为独立模块，并把接口有关的POJO、默认的Feign配置都放在这个模块中，提供给所有消费者使用</li>
</ul>
<img src="/2023/10/16/SpringCloud/feignExtract.png" alt="feignExtract" style="zoom:50%;">

<h3 id="抽取FeignClient"><a href="#抽取FeignClient" class="headerlink" title="抽取FeignClient"></a>抽取FeignClient</h3><p>步骤如下：</p>
<ol>
<li>首先创建一个module，命名为feign-api，然后引入feign的starter依赖</li>
<li>在feign-api项目中编写Client、Configuration等</li>
<li>在要使用的项目中中引入feign-api的依赖</li>
<li>在要使用的项目中引入feign-api的包</li>
</ol>
<p>当定义的FeignClient不在SpringBootApplication的扫描包范围时，这些FeignClient无法使用。有两种方式解决：</p>
<ul>
<li><p>方式一：指定FeignClient所在的包</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages = "cn.itcast.feign.clients")</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>方式二：指定FeignClient字节码</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(clients = {UserClient.class})</span></span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h1 id="统一网关Gateway"><a href="#统一网关Gateway" class="headerlink" title="统一网关Gateway"></a>统一网关Gateway</h1><h2 id="为什么需要网关"><a href="#为什么需要网关" class="headerlink" title="为什么需要网关"></a>为什么需要网关</h2><p>网关功能：</p>
<ul>
<li>身份认证和权限校验</li>
<li>服务路由、负载均衡</li>
<li>请求限流</li>
</ul>
<h2 id="网关的技术体现"><a href="#网关的技术体现" class="headerlink" title="网关的技术体现"></a>网关的技术体现</h2><p>在SpringCloud中网关的实现包括两种：</p>
<ul>
<li>gateway</li>
<li>zuul</li>
</ul>
<p>Zuul是基于Servlet的实现，属于阻塞式编程。而SpringCloudGateway则是基于Spring5中提供的WebFlux，属于响应式编程的实现，具备更好的性能</p>
<h2 id="搭建网关服务"><a href="#搭建网关服务" class="headerlink" title="搭建网关服务"></a>搭建网关服务</h2><p>搭建网关服务的步骤：</p>
<ol>
<li><p>创建新的module，引入SpringCloudGateway的依赖和nacos的服务发现依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>编写路由配置即nacos地址</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10010</span> <span class="comment"># 网关端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span> <span class="comment"># 服务名称</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># nacos地址</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment"># 网关路由配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">userService</span> <span class="comment"># 路由id，自定义，只要唯一即可</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 lb 就是负载均衡，后面跟服务名称</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://userService</span> <span class="comment"># 路由断言，也就是判断请求是否符合路由规定的条件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/**</span> <span class="comment"># 这个是按照路径匹配，只要以/user/开头就符合要求</span></span><br></pre></td></tr></tbody></table></figure>

<p>网关工作流程</p>
</li>
</ol>
<img src="/2023/10/16/SpringCloud/gatewaySequence.png" alt="gatewaySequence" style="zoom:50%;">

<h2 id="路由断言工厂-Route-Predicate-Factory"><a href="#路由断言工厂-Route-Predicate-Factory" class="headerlink" title="路由断言工厂 Route Predicate Factory"></a>路由断言工厂 Route Predicate Factory</h2><p>网关路由可以配置的内容包括：</p>
<ul>
<li>路由id：路由唯一标示</li>
<li>uri：路由目的地，支持lb和http两种</li>
<li>predicates：路由断言，判断请求是否符合要求，符合则转发到路由目的地</li>
<li>filters：路由过滤器，处理请求或响应</li>
</ul>
<p>配置文件中写的断言规则只是字符串，这些字符串会被Predicate Factory读取并处理，转变为路由规则判断的条件</p>
<p>例如Path=/user/**是按照路径匹配，这个规则由org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory类来处理，类似的断言工厂在SpringCloudGateway还有十多个</p>
<p>Spring提供了11种基本的Predicate工厂：</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">说明</th>
<th align="center">示例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">After</td>
<td align="center">是某个时间点后的请求</td>
<td align="center">- After=2023-01-20T17:42:47.789-07:00[America/Denver]</td>
</tr>
<tr>
<td align="center">Before</td>
<td align="center">是某个时间点之前的请求</td>
<td align="center">- Before=2031-04-13T15:14:47.433+8:00[Asia/Shanghai]</td>
</tr>
<tr>
<td align="center">Between</td>
<td align="center">是某两个时间点之前的请求</td>
<td align="center">- Between=2037-01-20T17:42:47.789-07:00[America/Denver], 2037-01-21T17:42:47.789-07:00[America/Denver]</td>
</tr>
<tr>
<td align="center">Cookie</td>
<td align="center">请求必须包含某些cookie</td>
<td align="center">- Cookie=chocolate, ch.p</td>
</tr>
<tr>
<td align="center">Header</td>
<td align="center">请求必须包含某些header</td>
<td align="center">- Header=X-Request-Id, \d+</td>
</tr>
<tr>
<td align="center">Host</td>
<td align="center">请求必须是访问某个Host（域名）</td>
<td align="center">- Host=**<em>.somehost.org, *</em>*.anotherhost.org</td>
</tr>
<tr>
<td align="center">Method</td>
<td align="center">请求方式必须是指定方式</td>
<td align="center">- Method=GET, POST</td>
</tr>
<tr>
<td align="center">Path</td>
<td align="center">请求路径必须符合制定规则</td>
<td align="center">- Path=/red/{segment},/blue/**</td>
</tr>
<tr>
<td align="center">Query</td>
<td align="center">请求参数必须包含指定参数</td>
<td align="center">- Query=name, Jack或者 - Query=name</td>
</tr>
<tr>
<td align="center">RemoteAddr</td>
<td align="center">请求者的ip必须是指定范围</td>
<td align="center">- RemoteAddr=192.168.1.1/24</td>
</tr>
<tr>
<td align="center">Weight</td>
<td align="center">权重处理</td>
<td align="center"></td>
</tr>
</tbody></table>
<h2 id="路由过滤器-GatewayFilter"><a href="#路由过滤器-GatewayFilter" class="headerlink" title="路由过滤器 GatewayFilter"></a>路由过滤器 GatewayFilter</h2><p>GatewayFIlter是网关中提供的一种过滤器，可以对进入网关的请求和微服务返回的响应做处理</p>
<img src="/2023/10/16/SpringCloud/gatewayFilter.png" alt="gatewayFilter" style="zoom:50%;">

<p>Spring提供了31种不同的过滤器工厂，详情可以查看Spring文档</p>
<h3 id="默认过滤器"><a href="#默认过滤器" class="headerlink" title="默认过滤器"></a>默认过滤器</h3><p>如果要对所有路由都生效，则可以将过滤器工厂写到default下，格式如下：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">gateway:</span></span><br><span class="line">			<span class="attr">default-filters:</span></span><br><span class="line">				<span class="string">-...</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="全局过滤器-GlobalFilter"><a href="#全局过滤器-GlobalFilter" class="headerlink" title="全局过滤器 GlobalFilter"></a>全局过滤器 GlobalFilter</h2><p>全局过滤器的作用也是注册一切进入网关的请求和微服务响应，与GatewayFilter的作用一样。</p>
<p>区别在于GatewayFilter通过配置定义，处理逻辑是固定的。而GlobalFilter的逻辑需要自己写代码实现。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GlobalFilter</span> {</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理当前请求，有必要的话通过{<span class="doctag">@link</span> GatewayFilterChain}将请求交给下一个过滤器处理</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> exchange 请求上下文，里面可以获取Request、Response等信息</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> chain 用来将请求委托给下一个过滤器</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> {<span class="doctag">@code</span> Mono&lt;Void&gt;} 返回标示当前过滤器业务结束</span></span><br><span class="line"><span class="comment">   Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);</span></span><br><span class="line"><span class="comment">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>示例：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {</span><br><span class="line">	<span class="comment">// 1.获取请求参数</span></span><br><span class="line">	<span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">	MultiValueMap&lt;String, String&gt; params = request.getQueryParams();</span><br><span class="line">  <span class="comment">// 2.获取参数中的authorization参数</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">auth</span> <span class="operator">=</span> params.getFirst(<span class="string">"authorization"</span>);</span><br><span class="line">  <span class="comment">// 3.判断阐述值是否等于 admin</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">"admin"</span>.equals(auth)) {</span><br><span class="line">		<span class="comment">// 4.是，放行</span></span><br><span class="line">		<span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">	}</span><br><span class="line">  <span class="comment">// 5.否，拦截</span></span><br><span class="line">  <span class="comment">// 5.1.设置状态码</span></span><br><span class="line">  exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">  <span class="comment">// 5.2.拦截请求</span></span><br><span class="line">  <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="过滤器执行顺序"><a href="#过滤器执行顺序" class="headerlink" title="过滤器执行顺序"></a>过滤器执行顺序</h2><p>请求进入网关会碰到三类过滤器：当前路由的过滤器、DefaultFilter、GlobalFilter</p>
<p>请求进入路由后，会将当前路由过滤器和DefaultFilter、GlobalFilter，合并到一个过滤器链（集合）中，排序后依次执行每个过滤器</p>
<ul>
<li>每一个过滤器都必须制定一个int类型的order值，<strong>order值越小，优先级越高，执行顺序越靠前</strong></li>
<li>GlobalFilter通过实现Ordered接口，或者添加@Order注解来指定order值，由自己指定</li>
<li>路由过滤器和DefaultFilter的order由Spring指定，默认是按照声明顺序从1递增</li>
<li>当过滤器的order值一样时，会按照DefaultFilter &gt; 路由过滤器 &gt; GlobalFilter的顺序执行</li>
</ul>
<h2 id="跨域问题处理"><a href="#跨域问题处理" class="headerlink" title="跨域问题处理"></a>跨域问题处理</h2><p>跨域：域名不一致就是跨域，主要包括：</p>
<ul>
<li>域名不同：<a target="_blank" rel="noopener" href="http://www.taobao.com和www.taobao.org和www.jd.com和miaosha.jd.com/">www.taobao.com和www.taobao.org和www.jd.com和miaosha.jd.com</a></li>
<li>域名相同，端口不相同：localhost:8080和localhost:8081</li>
</ul>
<p>跨域问题：浏览器禁止请求的发起者与服务端发生跨域ajax请求，请求被浏览器拦截的问题</p>
<p>解决方案：CORS</p>
<p>网关处理跨域采用的同样是CORS方案，并且只需要简单配置即可实现：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">globalcors:</span> <span class="comment"># 全局跨域处理</span></span><br><span class="line">	<span class="attr">add-to-simple-url-handler-mapping:</span> <span class="literal">true</span> <span class="comment"># 解决options请求被拦截问题</span></span><br><span class="line">	<span class="attr">cors-configurations:</span></span><br><span class="line">	<span class="string">'[/**]'</span><span class="string">:</span></span><br><span class="line">		<span class="attr">allowedOrigins:</span> <span class="comment"># 语序哪些网站的跨域请求</span></span><br><span class="line">			<span class="bullet">-</span> <span class="string">"http://localhost:8090"</span></span><br><span class="line">			<span class="bullet">-</span> <span class="string">"http://www.leyou.com"</span></span><br><span class="line">		<span class="attr">allowedMethods:</span> <span class="comment"># 允许的跨域ajax的请求方式</span></span><br><span class="line">			<span class="bullet">-</span> <span class="string">"GET"</span></span><br><span class="line">			<span class="bullet">-</span> <span class="string">"POST"</span></span><br><span class="line">			<span class="bullet">-</span> <span class="string">"DELETE"</span></span><br><span class="line">			<span class="bullet">-</span> <span class="string">"PUT"</span></span><br><span class="line">			<span class="bullet">-</span> <span class="string">"OPTIONS"</span></span><br><span class="line">		<span class="attr">allowedHeaders:</span> <span class="string">"*"</span> <span class="comment"># 允许在请求中携带的头信息</span></span><br><span class="line">		<span class="attr">allowCredentials:</span> <span class="literal">true</span> <span class="comment"># 是否允许携带cookie</span></span><br><span class="line">		<span class="attr">maxAge:</span> <span class="number">360000</span> <span class="comment"># 这次跨域检测的有效期</span></span><br></pre></td></tr></tbody></table></figure>

<h1 id="MQ"><a href="#MQ" class="headerlink" title="MQ"></a>MQ</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="同步通讯和异步通讯"><a href="#同步通讯和异步通讯" class="headerlink" title="同步通讯和异步通讯"></a>同步通讯和异步通讯</h3><h4 id="同步调用的问题"><a href="#同步调用的问题" class="headerlink" title="同步调用的问题"></a>同步调用的问题</h4><p>微服务间基于Feign的调用就属于同步方式，存在一些问题</p>
<ol>
<li>耦合度高，每次加入新的需求，都要修改原来的代码</li>
<li>性能下降，调用者需要等待服务提供者响应，如果调用链过长则响应时间等于每次调用的时间之和</li>
<li>资源浪费，调用链中的每个服务在等待响应过程中，不能释放请求占用的资源，高并发场景下会极度浪费系统资源</li>
<li>级联失败，如果服务提供者出现问题，所有调用方都会跟着出问题，如多米诺骨牌一样，迅速导致整个微服务群故障</li>
</ol>
<h4 id="异步调用方案"><a href="#异步调用方案" class="headerlink" title="异步调用方案"></a>异步调用方案</h4><p>异步调用常见实现就是事件驱动模式</p>
<p>优势一：服务解耦</p>
<p>优势二：性能提升，吞吐量提高</p>
<p>优势三：服务没有强依赖，不担心级联失败问题</p>
<p>优势四：流量削峰</p>
<h3 id="什么是MQ"><a href="#什么是MQ" class="headerlink" title="什么是MQ"></a>什么是MQ</h3><p>MQ（MessageQueue），中文是消息队列，字面来看就是存放消息的队列，也就是事件驱动架构中的Broker</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">RabbitMQ</th>
<th align="center">ActiveMQ</th>
<th align="center">RocketMQ</th>
<th align="center">Kafka</th>
</tr>
</thead>
<tbody><tr>
<td align="center">公司/社区</td>
<td align="center">Rabbit</td>
<td align="center">Apache</td>
<td align="center">阿里</td>
<td align="center">Apache</td>
</tr>
<tr>
<td align="center">开发语言</td>
<td align="center">Erlang</td>
<td align="center">java</td>
<td align="center">java</td>
<td align="center">Scala&amp;java</td>
</tr>
<tr>
<td align="center">协议支持</td>
<td align="center">AMQP、XMPP、SMTP、STOMP</td>
<td align="center">OpenWire，STOMP，REST，XMPP，AMQP</td>
<td align="center">自定义协议</td>
<td align="center">自定义协议</td>
</tr>
<tr>
<td align="center">可用性</td>
<td align="center">高</td>
<td align="center">一般</td>
<td align="center">高</td>
<td align="center">高</td>
</tr>
<tr>
<td align="center">单机吞吐量</td>
<td align="center">一般</td>
<td align="center">差</td>
<td align="center">高</td>
<td align="center">高</td>
</tr>
<tr>
<td align="center">消息延迟</td>
<td align="center">微秒级</td>
<td align="center">毫秒级</td>
<td align="center">毫秒级</td>
<td align="center">毫秒以内</td>
</tr>
<tr>
<td align="center">消息可靠性</td>
<td align="center">高</td>
<td align="center">一般</td>
<td align="center">高</td>
<td align="center">一般</td>
</tr>
</tbody></table>
<h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><img src="/2023/10/16/SpringCloud/rabbitmqStruct.png" alt="rabbitmqStruct" style="zoom:50%;">

<p>几个概念：</p>
<ul>
<li>channel：操作MQ的工具</li>
<li>exchange：路由消息到队列中</li>
<li>queue：缓存消息</li>
<li>virtual host：虚拟主机，是对queue、exchange等资源的逻辑分组</li>
</ul>
<h2 id="常见的消息模型"><a href="#常见的消息模型" class="headerlink" title="常见的消息模型"></a>常见的消息模型</h2><p>MQ的官方文档中给出了5个MQ的Demo示例，对应了几种不同的用法</p>
<ul>
<li>基本消息队列（BasicQueue）</li>
<li>工作消息队列（WorkQueue）</li>
<li>发布订阅（Publish、Subcribe），又根据交换机类型不同分为三种<ul>
<li>Fanout Exchange：广播</li>
<li>Direct Exchange：路由</li>
<li>Topic Exchange：主题</li>
</ul>
</li>
</ul>
<h3 id="HelloWorld案例"><a href="#HelloWorld案例" class="headerlink" title="HelloWorld案例"></a>HelloWorld案例</h3><p>官方的HelloWorld是基于最基础的消息队列模型来实现的，只包括三个角色：</p>
<ul>
<li>publisher：消息发布者，将详细发送到队列queue</li>
<li>queue：消息队列：负责接收并缓存消息</li>
<li>consumer：订阅队列，处理队列中的消息</li>
</ul>
<img src="/2023/10/16/SpringCloud/HelloWorldDemo.png" alt="HelloWorldDemo" style="zoom:50%;">

<p>基本消息队列的消息发送流程：</p>
<ol>
<li>建立connection</li>
<li>创建channel</li>
<li>利用channel声明队列</li>
<li>利用channel向队列发送消息</li>
</ol>
<p>基本消息队列的消息接收流程：</p>
<ol>
<li>建立connection</li>
<li>创建channel</li>
<li>利用channel声明队列</li>
<li>利用consumer的消费行为handleDelivery()</li>
<li>利用channel将消费者与队列绑定</li>
</ol>
<h1 id="SpringAMQP"><a href="#SpringAMQP" class="headerlink" title="SpringAMQP"></a>SpringAMQP</h1><h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><h3 id="AMQP"><a href="#AMQP" class="headerlink" title="AMQP"></a>AMQP</h3><p>Advanced Message Queuing Protocol，是用于在应用程序或之间传递业务消息的开放标准。该协议与语言和平台无关，更符合微服务中独立性的要求</p>
<h3 id="Spring-AMQP"><a href="#Spring-AMQP" class="headerlink" title="Spring AMQP"></a>Spring AMQP</h3><p>Spring AMQP是基于AMQP协议定义的一套API规范，提供了模板来发送和就收消息。包含两部分，其中spring-amqp是基础抽象，spring-rabbit是底层的默认实现</p>
<h2 id="SpringAMQP实现HelloWorld中的基础消息队列功能"><a href="#SpringAMQP实现HelloWorld中的基础消息队列功能" class="headerlink" title="SpringAMQP实现HelloWorld中的基础消息队列功能"></a>SpringAMQP实现HelloWorld中的基础消息队列功能</h2><p>流程如下：</p>
<ol>
<li><p>在父工程中引入spring-amqp的依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在publisher服务中利用RabbitTemplate发送消息到simple.queue这个队列</p>
<ul>
<li><p>在yml中添加rabbitmq的配置</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">***</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>编写方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage2SimpleQueue</span><span class="params">()</span> {</span><br><span class="line">	<span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">"simple.queue"</span>;</span><br><span class="line">	<span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"hello, spring amqp!"</span>;</span><br><span class="line">	rabbitTemplate.convertAndSend(queueName, message);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>在consumer服务中编写消费逻辑，绑定simple.queue这个队列</p>
<ul>
<li><p>在yml中添加rabbitmq的配置</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">***</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在consumer服务中新建一个类，编写消费逻辑</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = "simple.queue")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenSimpleQueue</span><span class="params">(String msg)</span> {</span><br><span class="line">	System.out.println(<span class="string">"消费者接收到simple.queue的消息: ["</span> + msg + <span class="string">"]"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
</li>
</ol>
<h2 id="Work-Queue-工作队列"><a href="#Work-Queue-工作队列" class="headerlink" title="Work Queue 工作队列"></a>Work Queue 工作队列</h2><p>Work queue，工作队列，可以提高消息处理速度，避免队列消息堆积</p>
<img src="/2023/10/16/SpringCloud/workqueueStruct.png" alt="workqueueStruct" style="zoom:50%;">

<h3 id="模拟WorkQueue，实现一个队列绑定多个消费者"><a href="#模拟WorkQueue，实现一个队列绑定多个消费者" class="headerlink" title="模拟WorkQueue，实现一个队列绑定多个消费者"></a>模拟WorkQueue，实现一个队列绑定多个消费者</h3><p>基本思路如下：</p>
<ol>
<li>在publisher服务中定义测试方法，每秒产生50条消息，发送到simple.queue</li>
<li>在consumer服务中定义两个消息监听者，都监听simple.queue队列</li>
<li>消费者1每秒处理50条信息，消费者2每秒处理10条消息</li>
</ol>
<h3 id="消费预取限制"><a href="#消费预取限制" class="headerlink" title="消费预取限制"></a>消费预取限制</h3><p>修改applicaiton.yml文件，设置preFetch这个值，可以控制预取消息的上限</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">rabbitmq:</span></span><br><span class="line">		<span class="attr">listener:</span></span><br><span class="line">			<span class="attr">simple:</span></span><br><span class="line">				<span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 每次只能获取一条消息，处理完成才能获取下一条消息</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="发布（Publish）、订阅（Subscribe）"><a href="#发布（Publish）、订阅（Subscribe）" class="headerlink" title="发布（Publish）、订阅（Subscribe）"></a>发布（Publish）、订阅（Subscribe）</h2><p>发布订阅模式与之前案例的区别是允许将同一消息发送给多个消费者。实现方式是加入了exchange（交换机）</p>
<p>常见exchange类型包括：</p>
<ul>
<li>Fanout：广播</li>
<li>Direct：路由</li>
<li>Topic：话题</li>
</ul>
<p><strong>注意</strong>：exchange负责消息路由，而不是存储，路由失败则消息丢失</p>
<img src="/2023/10/16/SpringCloud/publishSubscribeStruct.png" alt="publishSubscribeStruct" style="zoom:50%;">

<h3 id="发布订阅-Fanout-Exchange"><a href="#发布订阅-Fanout-Exchange" class="headerlink" title="发布订阅-Fanout Exchange"></a>发布订阅-Fanout Exchange</h3><p>Fanout Exchange会将接收到的消息路由到每一个跟其绑定的queue</p>
<img src="/2023/10/16/SpringCloud/fanoutExchangeStruct.png" alt="fanoutExchangeStruct" style="zoom:50%;">

<h4 id="利用SpringAMQP实现FanoutExchange的使用"><a href="#利用SpringAMQP实现FanoutExchange的使用" class="headerlink" title="利用SpringAMQP实现FanoutExchange的使用"></a>利用SpringAMQP实现FanoutExchange的使用</h4><p>思路如下；</p>
<ol>
<li><p>在consumer服务中，利用代码声明队列、交换机，并将两者绑定</p>
<ul>
<li><p>在consumer服务创建一个类，添加 <code>@Configuration</code> 注解，并声明FanoutExchange、Queue和绑定关系对象Binding，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchange</span><span class="params">()</span> {</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(<span class="string">"itcast.fanout"</span>)</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">fanoutQueue1</span><span class="params">()</span> {</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"fanout.queue1"</span>)</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">fanoutQueue2</span><span class="params">()</span> {</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"fanout.queue2"</span>)</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">fanoutBinding1</span><span class="params">(Queue fanoutQueue1, FanoutExchange fanoutExchange)</span> {</span><br><span class="line">	<span class="keyword">return</span> BindingBuilder</span><br><span class="line">				.bind(fanoutQueue1)</span><br><span class="line">				.to(fanoutExchange)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">fanoutBinding2</span><span class="params">(Queue fanoutQueue2, FanoutExchange fanoutExchange)</span> {</span><br><span class="line">	<span class="keyword">return</span> BindingBuilder</span><br><span class="line">				.bind(fanoutQueue2)</span><br><span class="line">				.to(fanoutExchange)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


</li>
</ul>
</li>
<li><p>在consumer服务中，编写两个消费者方法，分别监听fanout.queue1和fanout.queue2</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchange</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(<span class="string">"itcast.fanout"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">fanoutQueue1</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"fanout.queue1"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">fanoutQueue2</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"fanout.queue2"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">fanoutBinding1</span><span class="params">(Queue fanoutQueue1, FanoutExchange fanoutExchange)</span> {</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder</span><br><span class="line">            .bind(fanoutQueue1)</span><br><span class="line">            .to(fanoutExchange);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">fanoutBinding2</span><span class="params">(Queue fanoutQueue2, FanoutExchange fanoutExchange)</span> {</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder</span><br><span class="line">            .bind(fanoutQueue2)</span><br><span class="line">            .to(fanoutExchange);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在publisher中编写测试方法，向itcast.fanout发送消息</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendFanoutExchange</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">"itcast.fanout"</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"hello, every one!"</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">""</span>, message);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h3 id="发布订阅-DirectExchange"><a href="#发布订阅-DirectExchange" class="headerlink" title="发布订阅-DirectExchange"></a>发布订阅-DirectExchange</h3><p>Direct Exchange会将接收到的消息根据规则路由到指定的Queue，因此称为路由模式（routes）</p>
<ul>
<li>每一个Queue都与Exchange设置一个BindingKey</li>
<li>发布者发送消息时，指定消息的RoutingKey</li>
<li>Exchange将消息路由到BindingKey与消息RoutingKey一致的队列</li>
</ul>
<img src="/2023/10/16/SpringCloud/directExchangeStruct.png" alt="directExchangeStruct" style="zoom:50%;">

<h4 id="利用SpringAMQP实现DirectExchange的使用"><a href="#利用SpringAMQP实现DirectExchange的使用" class="headerlink" title="利用SpringAMQP实现DirectExchange的使用"></a>利用SpringAMQP实现DirectExchange的使用</h4><p>实现思路如下：</p>
<ol>
<li><p>利用@RabbitListener声明Exchange、Queue、RoutingKey</p>
</li>
<li><p>在consumer服务中，编写两个消费者方法，分别监听direct.queue1和direct.queue2</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = "direct.queue1"),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = "itcast.direct", type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">        key = {"red", "blue"}</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue1</span><span class="params">(String msg)</span> {</span><br><span class="line">    System.out.println(<span class="string">"消费者接收到direct.queue1的消息: ["</span> + msg + <span class="string">"]"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = "direct.queue2"),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = "itcast.direct", type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">        key = {"red", "yello2"}</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue2</span><span class="params">(String msg)</span> {</span><br><span class="line">    System.out.println(<span class="string">"消费者接收到direct.queue1的消息: ["</span> + msg + <span class="string">"]"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在publisher中编写测试方法，向itcast.direct发送消息</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendDirectExchange</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">"itcast.direct"</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"hello, blue!"</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">"red"</span>, message);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h3 id="发布订阅-TopicExchange"><a href="#发布订阅-TopicExchange" class="headerlink" title="发布订阅-TopicExchange"></a>发布订阅-TopicExchange</h3><p>TopicExchange与DirectExchange类似，区别在于routingKey必须是多个单词的列表，并且以 <code>.</code> 分割</p>
<p>Queue与Exchange指定BindingKey时可以使用通配符</p>
<p>#：代指0个或多个单词</p>
<p>*：代指一个单词</p>
<img src="/2023/10/16/SpringCloud/topicExchangeStruct.png" alt="topicExchangeStruct" style="zoom:50%;">

<h4 id="利用SpringAMQP演示TopicExchange的使用"><a href="#利用SpringAMQP演示TopicExchange的使用" class="headerlink" title="利用SpringAMQP演示TopicExchange的使用"></a>利用SpringAMQP演示TopicExchange的使用</h4><p>思路如下；</p>
<ol>
<li><p>利用 <code>@RabbitListener</code> 声明Exchange、Queue、RoutingKey</p>
</li>
<li><p>在consumer服务中，编写两个消费者方法，分别监听topic.queue1和topic.queue2</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue("topic.queue1"),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = "itcast.topic", type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">        key = "china.#"</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue1</span><span class="params">(String msg)</span> {</span><br><span class="line">    System.out.println(<span class="string">"消费者接收到direct.queue1的消息: ["</span> + msg + <span class="string">"]"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue("topic.queue2"),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = "itcast.topic", type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">        key = "#.news"</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue2</span><span class="params">(String msg)</span> {</span><br><span class="line">    System.out.println(<span class="string">"消费者接收到direct.queue2的消息: ["</span> + msg + <span class="string">"]"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在publisher中编写测试方法，向itcast.topic发送消息</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendTopicExchange</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">"itcast.topic"</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"创智教育上市了"</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName, <span class="string">"china.news"</span>, message);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h3 id="SpringAMQP-消息转换器"><a href="#SpringAMQP-消息转换器" class="headerlink" title="SpringAMQP-消息转换器"></a>SpringAMQP-消息转换器</h3><h4 id="测试发送Object类型消息"><a href="#测试发送Object类型消息" class="headerlink" title="测试发送Object类型消息"></a>测试发送Object类型消息</h4><p>在SpringAMQP的发送方法中，接收消息的类型是Object，也就是可以发送任意对象类型的消息，SpringAMQP会序列化成字节后发送</p>
<h4 id="消息转换器"><a href="#消息转换器" class="headerlink" title="消息转换器"></a>消息转换器</h4><p>Spring的对消息对象的处理是由 <code>org.springframework.amqp.support.converter.MessageConverter</code> 来处理的。而默认实现是SimpleMessageConverter，基于JDK的ObjectOutputStream完成序列化</p>
<p>如果要修改只需要定义一个MessageConverter类型的Bean即可。推荐使用JSON方式序列化</p>
<ul>
<li><p>首先引入依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在publisher和Customer服务声明MessageConverter</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">jsonMessageConverter</span><span class="params">()</span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


</li>
</ul>
</body></html>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/JavaWeb/" rel="tag"># JavaWeb</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/10/16/git/" rel="prev" title="Git">
      <i class="fa fa-chevron-left"></i> Git
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/10/20/Docker/" rel="next" title="Docker">
      Docker <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BB%93%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">微服务结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%A4%E8%AF%86%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.</span> <span class="nav-text">认识微服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98"><span class="nav-number">2.1.</span> <span class="nav-text">服务架构演变</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-number">2.1.1.</span> <span class="nav-text">单体架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="nav-number">2.1.2.</span> <span class="nav-text">分布式架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.1.3.</span> <span class="nav-text">微服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BB%93%E6%9E%84-1"><span class="nav-number">2.1.4.</span> <span class="nav-text">微服务结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringCloud"><span class="nav-number">2.2.</span> <span class="nav-text">SpringCloud</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E5%92%8C%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">服务拆分和远程调用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">3.1.</span> <span class="nav-text">服务拆分注意事项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="nav-number">3.2.</span> <span class="nav-text">微服务远程调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8RestTemplate"><span class="nav-number">3.2.1.</span> <span class="nav-text">使用RestTemplate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E4%BE%9B%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">3.2.2.</span> <span class="nav-text">提供者与消费者</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Eureka%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">4.</span> <span class="nav-text">Eureka注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Eureka%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">4.1.</span> <span class="nav-text">Eureka的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BAEurekaServer"><span class="nav-number">4.2.</span> <span class="nav-text">搭建EurekaServer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8Cuser-service"><span class="nav-number">4.3.</span> <span class="nav-text">注册user-service</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%8B%89%E5%8F%96"><span class="nav-number">4.4.</span> <span class="nav-text">服务拉取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">4.5.</span> <span class="nav-text">Ribbon负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%B5%81%E7%A8%8B"><span class="nav-number">4.5.1.</span> <span class="nav-text">负载均衡流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="nav-number">4.5.2.</span> <span class="nav-text">负载均衡策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A5%A5%E9%A5%BF%E5%8A%A0%E8%BD%BD"><span class="nav-number">4.5.2.1.</span> <span class="nav-text">饥饿加载</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">5.</span> <span class="nav-text">Nacos注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A4%E8%AF%86Nacos"><span class="nav-number">5.1.</span> <span class="nav-text">认识Nacos</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%88%B0Nacos"><span class="nav-number">5.2.</span> <span class="nav-text">服务注册到Nacos</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E6%9C%8D%E5%8A%A1%E5%88%86%E7%BA%A7%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B"><span class="nav-number">5.3.</span> <span class="nav-text">Nacos服务分级存储模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E6%A8%A1%E5%9E%8B"><span class="nav-number">5.3.1.</span> <span class="nav-text">具体模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E8%B7%A8%E9%9B%86%E7%BE%A4%E8%B0%83%E7%94%A8%E9%97%AE%E9%A2%98"><span class="nav-number">5.3.2.</span> <span class="nav-text">服务跨集群调用问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4%E5%B1%9E%E6%80%A7"><span class="nav-number">5.3.3.</span> <span class="nav-text">服务集群属性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NacosRule%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="nav-number">5.4.</span> <span class="nav-text">NacosRule负载均衡策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E6%9D%83%E9%87%8D%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">5.5.</span> <span class="nav-text">根据权重负载均衡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB-namespace"><span class="nav-number">5.6.</span> <span class="nav-text">环境隔离 - namespace</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86"><span class="nav-number">5.7.</span> <span class="nav-text">Nacos注册中心原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%BB%86%E8%8A%82%E5%88%86%E6%9E%90"><span class="nav-number">5.7.1.</span> <span class="nav-text">Nacos注册中心细节分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B%E5%92%8C%E9%9D%9E%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B"><span class="nav-number">5.7.2.</span> <span class="nav-text">临时实例和非临时实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E5%92%8CEureka%E7%9A%84%E6%AF%94%E8%BE%83"><span class="nav-number">5.8.</span> <span class="nav-text">Nacos和Eureka的比较</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B1%E5%90%8C%E7%82%B9"><span class="nav-number">5.8.1.</span> <span class="nav-text">共同点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%BA%E5%88%AB"><span class="nav-number">5.8.2.</span> <span class="nav-text">区别</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nacos%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="nav-number">6.</span> <span class="nav-text">Nacos配置管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%9F%E4%B8%80%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="nav-number">6.1.</span> <span class="nav-text">统一配置管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%85%B1%E4%BA%AB"><span class="nav-number">6.2.</span> <span class="nav-text">多环境配置共享</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">6.2.1.</span> <span class="nav-text">多服务配置优先级</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HTTP%E5%AE%A2%E6%88%B7%E7%AB%AFFeign"><span class="nav-number">7.</span> <span class="nav-text">HTTP客户端Feign</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RestTemplate%E6%96%B9%E5%BC%8F%E8%B0%83%E7%94%A8%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">7.1.</span> <span class="nav-text">RestTemplate方式调用存在的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Feign%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-number">7.2.</span> <span class="nav-text">Feign的介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E5%92%8C%E4%BD%BF%E7%94%A8Feign%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">7.3.</span> <span class="nav-text">定义和使用Feign客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Feign%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">7.4.</span> <span class="nav-text">自定义Feign的配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Feign%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">7.5.</span> <span class="nav-text">Feign的性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Feign%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E8%BF%9E%E6%8E%A5%E6%B1%A0%E9%85%8D%E7%BD%AE"><span class="nav-number">7.5.1.</span> <span class="nav-text">Feign的性能优化-连接池配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Feign%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">7.6.</span> <span class="nav-text">Feign的最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%BD%E5%8F%96FeignClient"><span class="nav-number">7.6.1.</span> <span class="nav-text">抽取FeignClient</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%9F%E4%B8%80%E7%BD%91%E5%85%B3Gateway"><span class="nav-number">8.</span> <span class="nav-text">统一网关Gateway</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E7%BD%91%E5%85%B3"><span class="nav-number">8.1.</span> <span class="nav-text">为什么需要网关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E5%85%B3%E7%9A%84%E6%8A%80%E6%9C%AF%E4%BD%93%E7%8E%B0"><span class="nav-number">8.2.</span> <span class="nav-text">网关的技术体现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1"><span class="nav-number">8.3.</span> <span class="nav-text">搭建网关服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82-Route-Predicate-Factory"><span class="nav-number">8.4.</span> <span class="nav-text">路由断言工厂 Route Predicate Factory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E8%BF%87%E6%BB%A4%E5%99%A8-GatewayFilter"><span class="nav-number">8.5.</span> <span class="nav-text">路由过滤器 GatewayFilter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">8.5.1.</span> <span class="nav-text">默认过滤器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8-GlobalFilter"><span class="nav-number">8.6.</span> <span class="nav-text">全局过滤器 GlobalFilter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="nav-number">8.7.</span> <span class="nav-text">过滤器执行顺序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86"><span class="nav-number">8.8.</span> <span class="nav-text">跨域问题处理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MQ"><span class="nav-number">9.</span> <span class="nav-text">MQ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">9.1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E9%80%9A%E8%AE%AF%E5%92%8C%E5%BC%82%E6%AD%A5%E9%80%9A%E8%AE%AF"><span class="nav-number">9.1.1.</span> <span class="nav-text">同步通讯和异步通讯</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">9.1.1.1.</span> <span class="nav-text">同步调用的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E6%96%B9%E6%A1%88"><span class="nav-number">9.1.1.2.</span> <span class="nav-text">异步调用方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFMQ"><span class="nav-number">9.1.2.</span> <span class="nav-text">什么是MQ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ"><span class="nav-number">9.2.</span> <span class="nav-text">RabbitMQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">9.3.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B"><span class="nav-number">9.4.</span> <span class="nav-text">常见的消息模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HelloWorld%E6%A1%88%E4%BE%8B"><span class="nav-number">9.4.1.</span> <span class="nav-text">HelloWorld案例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringAMQP"><span class="nav-number">10.</span> <span class="nav-text">SpringAMQP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="nav-number">10.1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AMQP"><span class="nav-number">10.1.1.</span> <span class="nav-text">AMQP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-AMQP"><span class="nav-number">10.1.2.</span> <span class="nav-text">Spring AMQP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringAMQP%E5%AE%9E%E7%8E%B0HelloWorld%E4%B8%AD%E7%9A%84%E5%9F%BA%E7%A1%80%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%8A%9F%E8%83%BD"><span class="nav-number">10.2.</span> <span class="nav-text">SpringAMQP实现HelloWorld中的基础消息队列功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Work-Queue-%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97"><span class="nav-number">10.3.</span> <span class="nav-text">Work Queue 工作队列</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9FWorkQueue%EF%BC%8C%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%98%9F%E5%88%97%E7%BB%91%E5%AE%9A%E5%A4%9A%E4%B8%AA%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">10.3.1.</span> <span class="nav-text">模拟WorkQueue，实现一个队列绑定多个消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E9%A2%84%E5%8F%96%E9%99%90%E5%88%B6"><span class="nav-number">10.3.2.</span> <span class="nav-text">消费预取限制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%EF%BC%88Publish%EF%BC%89%E3%80%81%E8%AE%A2%E9%98%85%EF%BC%88Subscribe%EF%BC%89"><span class="nav-number">10.4.</span> <span class="nav-text">发布（Publish）、订阅（Subscribe）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85-Fanout-Exchange"><span class="nav-number">10.4.1.</span> <span class="nav-text">发布订阅-Fanout Exchange</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8SpringAMQP%E5%AE%9E%E7%8E%B0FanoutExchange%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">10.4.1.1.</span> <span class="nav-text">利用SpringAMQP实现FanoutExchange的使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85-DirectExchange"><span class="nav-number">10.4.2.</span> <span class="nav-text">发布订阅-DirectExchange</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8SpringAMQP%E5%AE%9E%E7%8E%B0DirectExchange%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">10.4.2.1.</span> <span class="nav-text">利用SpringAMQP实现DirectExchange的使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85-TopicExchange"><span class="nav-number">10.4.3.</span> <span class="nav-text">发布订阅-TopicExchange</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8SpringAMQP%E6%BC%94%E7%A4%BATopicExchange%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">10.4.3.1.</span> <span class="nav-text">利用SpringAMQP演示TopicExchange的使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringAMQP-%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="nav-number">10.4.4.</span> <span class="nav-text">SpringAMQP-消息转换器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%8F%91%E9%80%81Object%E7%B1%BB%E5%9E%8B%E6%B6%88%E6%81%AF"><span class="nav-number">10.4.4.1.</span> <span class="nav-text">测试发送Object类型消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="nav-number">10.4.4.2.</span> <span class="nav-text">消息转换器</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">MANVND</p>
  <div class="site-description" itemprop="description">There is no royal road to learning</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">MANVND</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
